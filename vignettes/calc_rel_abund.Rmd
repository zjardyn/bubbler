---
title: "2. Calculate relative abundance"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{calc_rel_abund}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>", 
  fig.width = 7
  
)
```

```{r setup}
library(bubbler)
```
# Relative abundance
 
For a given group of samples, relative abundance is calculated as:


$\text{Relative abundance} = \frac{x_i}{\sum x}$


Where $x_i$ is the count of a given asv, divided by the sum of all asv counts, across all samples. This way, the sum of all relative abundances equal one. 


It is useful to visualize your data in this form to see the proportional counts between samples. 


```{r load_qiime, echo=FALSE}
# path to qiime-formatted asv counts 
counts_q <- system.file("extdata", "qiime", "table-dada2.qza", package = "bubbler")

# path to qiime-formatted taxonomy data 
taxa_q <- system.file("extdata", "qiime", "taxonomy.qza", package = "bubbler")

# path to qiime-formatted metadata
metadata_q <- system.file("extdata", "qiime", "sample-metadata.tsv", package = "bubbler")
```

```{r fig.height= 6 }
# 1. make rel_abund
rel_abund  <-  rel_abund_qiime(counts_q, 
                               taxa_q, 
                               metadata_q,
                               taxa_level = "Genus")

# 2. modify rel_abund
rel_abund_pool <- rel_abund %>%
    # pool taxa so that only the 12 most abundant taxa are displayed 
    pool_taxa(n_taxa = 12, keep_metadata = TRUE) 

library(ggplot2)

# 3. plot rel_abund
rel_abund_pool %>%
    bar_plot(color = "subject")  + 
    # group samples by body site. free_x removes unwanted white space
    facet_wrap(~body_site, scales = "free_x" ) 

```


Subject proportions in most cases are different, which would not be captured in a filled barplot. 


```{r}
rel_abund_pool %>%
    bar_plot(position = "fill", color = "subject")  + 
    # group samples by body site. free_x removes unwanted white space
    facet_wrap(~body_site, scales = "free_x")
```


By filling the plot, the relative abundance is being scaled to one, within each sample. We can also precompute this in our table:


```{r, eval=FALSE}
rel_abund_qiime(counts_q, 
                taxa_q,
                metadata_q,
                taxa_level = "Genus",
                var = "sample_id") # set the grouping variable to sample_id
```


Our relative abundances "stack" to one in this scenario. By filling the plotting area, we get a better representation of the between-sample composition, at the cost of obfuscating the between-sample proportions.

## Visualizing variables 

Bubbler can easily allow you to visualize relative abundances by another variable of interest. Imagine you wanted to look at relative abundance across `body_site`, rather than `sample_id` on the x-axis. This can be done by modifying the `x_var` argument of `bubbler::bar_plot`.


```{r}
rel_abund_qiime(counts_q,
                taxa_q,
                metadata_q,
                taxa_level = "Genus") %>%
    pool_taxa(n_taxa = 12,
              keep_metadata = TRUE) %>%
    arrange_taxa() %>%
    bar_plot(x_var = "body_site")
```


Again, this plot could be scaled in two ways: 


```{r, eval=FALSE}
# compute in rel_abund
rel_abund_qiime(counts_q,
                taxa_q,
                metadata_q,
                taxa_level = "Genus",
                var = "body_site") %>% #  scaling by body_site
    pool_taxa(n_taxa = 12,
              keep_metadata = TRUE) %>%
    arrange_taxa() %>%
    bar_plot(x_var = "body_site") # setting body_site as x_var

# scale in plot
rel_abund_qiime(counts_q,
                taxa_q,
                metadata_q,
                taxa_level = "Genus") %>%
    pool_taxa(n_taxa = 12,
              keep_metadata = TRUE) %>%
    arrange_taxa() %>%
    bar_plot(position = "fill", x_var = "body_site") # setting position as fill

```


The grouped relative abundance is calculated as: 

$\text{Grouped relative abundance} = \frac{x_i}{\sum_{j=1}^{k} x_j}$

Where $k$ is the levels of the grouping variable. 


